// This is an independent project of an individual developer. Dear PVS-Studio, please check it.
// PVS-Studio Static Code Analyzer for C, C++ and C#: http://www.viva64.com
#include "defines.h"
#include "Menu/MenuItems.h"
#include "Utils/Measures.h"
#include "Settings/Settings.h"
#include "Utils/Math.h"
#include "Utils/GlobalFunctions.h"
#include "Menu/Pages/Definition.h"
#include "Hardware/Sound.h"
#include "FPGA/fpgaExtensions.h  "


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
static const    Page ppFreqMeter;                       ///< ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ
static const   Choice cFreqMeter_Enable;                ///< ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - ×àñòîòîìåð
static void  OnChanged_FreqMeter_Enable(bool param);    
static const   Choice cFreqMeter_TimeF;                 ///< ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Âðåìÿ ñ÷¸òà F
static const   Choice cFreqMeter_FreqClc;               ///< ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Ìåòêè âðåìåíè
static const   Choice cFreqMeter_NumPeriods;            ///< ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Êîë-âî ïåðèîäîâ
static const   Choice cIsShow;                          ///< ÈÇÌÅÐÅÍÈß - Ïîêàçûâàòü
static const   Choice cNumber;                          ///< ÈÇÌÅÐÅÍÈß - Êîëè÷åñòâî
static bool   IsActive_Number(void);
static const   Choice cChannels;                        ///< ÈÇÌÅÐÅÍÈß - Êàíàëû
static bool   IsActive_Channels(void);
static const    Page ppTune;                            ///< ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ
static bool   IsActive_Tune(void);
static void   OnRegSet_Tune(int angle);
static const  SButton bTune_Exit;                       ///< ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Âûõîä
static const  SButton bTune_Markers;                    ///< ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Ìàðêåðû
static void    OnPress_Tune_Markers(void);
static void       Draw_Tune_Markers(int x, int y);
static const  SButton bTune_Settings;                   ///< ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Íàñòðîéêà
static void    OnPress_Tune_Settings(void);
static void  Draw_Tune_Settings(int x, int y);
static const   Choice cMode;                            ///< ÈÇÌÅÐÅÍÈß - Âèä
static bool   IsActive_Mode(void);

int8 posActive = 0;                 ///< Ïîçèöèÿ àêòèâíîãî èçìåðåíèÿ (íà êîòîðîì êóðñîð)
bool pageChoiceIsActive = false;    ///< Åñëè true - ðàñêðûòà ñòðàíèöà âûáîðà èçìåðåíèÿ
int8 posOnPageChoice = 0;           ///< Ïîçèöèÿ êóðñîðà íà ñòðàíèöå âûáîðà èçìåðåíèÿ

extern const Page mainPage;


// ÈÇÌÅÐÅÍÈß /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const Page pMeasures =
{
    Item_Page, &mainPage, 0,
    {
        "ÈÇÌÅÐÅÍÈß", "MEASURES",
        "Àâòîìàòè÷åñêèå èçìåðåíèÿ",
        "Automatic measurements"
    },
    Page_Measures,
    {
        (void *)&ppFreqMeter,   // ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ
        (void *)&cIsShow,       // ÈÇÌÅÐÅÍÈß - Ïîêàçûâàòü
        (void *)&cNumber,       // ÈÇÌÅÐÅÍÈß - Êîëè÷åñòâî
        (void *)&cChannels,     // ÈÇÌÅÐÅÍÈß - Êàíàëû
        (void *)&ppTune,        // ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ
        (void *)&cMode          // ÈÇÌÅÐÅÍÈß - Âèä
    }
};

// ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const Page ppFreqMeter =
{
    Item_Page, &pMeasures, 0,
    {
        "×ÀÑÒÎÒÎÌÅÐ", "FREQ METER",
        "",
        ""
    },
    Page_Service_FreqMeter,
    {
        (void *)&cFreqMeter_Enable,     // ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - ×àñòîòîìåð
        (void *)&cFreqMeter_TimeF,      // ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Âðåìÿ ñ÷¸òà F
        (void *)&cFreqMeter_FreqClc,    // ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Ìåòêè âðåìåíè
        (void *)&cFreqMeter_NumPeriods  // ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Êîë-âî ïåðèîäîâ
    }
};

// ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - ×àñòîòîìåð ---------------------------------------------------------------------------------------------------------------
static const Choice cFreqMeter_Enable =
{
    Item_Choice, &ppFreqMeter, 0,
    {
        "×àñòîòîìåð", "Freq meter",
        "",
        ""
    },
    {
        {DISABLE_RU, DISABLE_EN},
        {ENABLE_RU, ENABLE_EN}
    },
    (int8 *)&FREQ_METER_ENABLED, OnChanged_FreqMeter_Enable
};

static void OnChanged_FreqMeter_Enable(bool param)
{
    FreqMeter_Init();
}

// ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Âðåìÿ ñ÷¸òà F ------------------------------------------------------------------------------------------------------------
static const Choice cFreqMeter_TimeF =
{
    Item_Choice, &ppFreqMeter, 0,
    {
        "Âðåìÿ ñ÷¸òà F", "Time calc F",
        "Ïîçâîëÿåò âûáðàòü òî÷íîñòü èçìåðåíèÿ ÷àñòîòû - ÷åì áîëüøå âðåìÿ, òåì áîëüøå òî÷íîñòü è áîëüøå âðåìÿ èçìåðåíèÿ",
        "Allows to choose the accuracy of measurement of frequency - the more time, the accuracy more time of measurement is more"
    },
    {
        {"100ìñ", "100ms"},
        {"1ñ", "1s"},
        {"10ñ", "10ms"}
    },
    (int8 *)&FREQ_METER_TIMECOUNTING, OnChanged_FreqMeter_Enable
};

// ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Ìåòêè âðåìåíè ------------------------------------------------------------------------------------------------------------
static const Choice cFreqMeter_FreqClc =
{
    Item_Choice, &ppFreqMeter, 0,
    {
        "Ìåòêè âðåìåíè", "Timestamps",
        "Âûáîð ÷àñòîòû ñëåäîâàíèÿ ñ÷¸òíûõ èìïóëüñîâ",
        "Choice of frequency of following of calculating impulses"
    },
    {
        {"100êÃö", "10MHz"},
        {"1ÌÃö", "200MHz"},
        {"10ÌÃö", "10MHz"},
        {"100ÌÃö", "100MHz"}
    },
    (int8 *)&FREQ_METER_FREQ_CLC, OnChanged_FreqMeter_Enable
};

// ÈÇÌÅÐÅÍÈß - ×ÀÑÒÎÒÎÌÅÐ - Êîë-âî ïåðèîäîâ ----------------------------------------------------------------------------------------------------------
static const Choice cFreqMeter_NumPeriods =
{
    Item_Choice, &ppFreqMeter, 0,
    {
        "Êîë-âî ïåðèîäîâ", "Num periods",
        "Ïîçâîëÿåò âûáðàòü òî÷íîñòü èçìåðåíèÿ ïåðèîäà - ÷åì áîëüøå âðåìÿ, òåì áîëüøå òî÷íîñòü è áîëüøå âðåìÿ èçìåðåíèÿ",
        "Allows to choose the accuracy of measurement of period - the more time, the accuracy more time of measurement is more"
    },
    {
        {"1", "1"},
        {"10", "10"},
        {"100", "100"}
    },
    (int8 *)&FREQ_METER_NUM_PERIODS, OnChanged_FreqMeter_Enable
};

// ÈÇÌÅÐÅÍÈß - Ïîêàçûâàòü ----------------------------------------------------------------------------------------------------------------------------
static const Choice cIsShow =
{
    Item_Choice, &pMeasures, 0,
    {
        "Ïîêàçûâàòü", "Show",
        "Âûâîäèòü èëè íå âûâîäèòü èçìåðåíèÿ íà ýêðàí",
        "Output or output measurements on screen"
    },
    {
        {"Íåò", "No"},
        {"Äà", "Yes"}
    },
    (int8 *)&SHOW_MEASURES
};

// ÈÇÌÅÐÅÍÈß - Êîëè÷åñòâî ----------------------------------------------------------------------------------------------------------------------------
static const Choice cNumber =
{
    Item_Choice, &pMeasures, IsActive_Number,
    {
        "Êîëè÷åñòâî", "Number"
        ,
        "Óñòàíàâëèâàåò ìàêñèìàëüíîå êîëè÷åñòâî âûâîäèìûõ èçìåðåíèé:\n"
        "\"1\" - îäíî èçìåðåíèå\n"
        "\"2\" - äâà èçìåðåíèÿ\n"
        "\"1õ5\" - 1 ñòðîêà ñ ïÿòüþ èçìåðåíèÿìè\n"
        "\"2õ5\" - 2 ñòðîêè ñ ïÿòüþ èçìåðåíèÿìè â êàæäîé\n"
        "\"3õ5\" - 3 ñòðîêè ñ ïÿòüþ èçìåðåíèÿìè â êàæäîé\n"
        "\"6x1\" - 6 ñòðîê ïî îäíîìó èçìåðåíèþ â êàæäîé\n"
        "\"6õ2\" - 6 ñòðîê ïî äâà èçìåðåíèÿ â êàæäîé"
        ,
        "Sets the maximum number of output measurements:\n"
        "\"1\" - one measurement\n"
        "\"2\" - two measurements\n"
        "\"1x5\" - 1 line with the five dimensions\n"
        "\"2x5\" - two rows with five measurements in each\n"
        "\"3x5\" - 3 lines with five measurements in each"
        "\"6x1\" - 6 lines, one in each dimension\n"
        "\"6x2\" - 6 lines of two dimensions in each\n"
    },
    {
        {"1", "1"},
        {"2", "2"},
        {"1x5", "1x5"},
        {"2x5", "2x5"},
        {"3x5", "3x5"},
        {"6x1", "6x1"},
        {"6x2", "6x2"}
    },
    (int8 *)&NUM_MEASURES
};

static bool IsActive_Number(void)
{
    return SHOW_MEASURES;
}

// ÈÇÌÅÐÅÍÈß - Êàíàëû --------------------------------------------------------------------------------------------------------------------------------
static const Choice cChannels =
{
    Item_Choice, &pMeasures, IsActive_Channels,
    {
        "Êàíàëû", "Channels",
        "Ïî êàêèì êàíàëàì âûâîäèòü èçìåðåíèÿ",
        "Which channels to output measurement"
    },
    {
        {"1", "1"},
        {"2", "2"},
        {"1 è 2", "1 and 2"}
    },
    (int8 *)&SOURCE_MEASURE
};

static bool IsActive_Channels(void)
{
    return SHOW_MEASURES;
}

// ÈÇÌÅÐÅÍÈß - Âèä -----------------------------------------------------------------------------------------------------------------------------------
static const Choice cMode =
{
    Item_Choice, &pMeasures, IsActive_Mode,
    {
        "Âèä", "View",
        "Óìåíüøàòü èëè íåò çîíó âûâîäà ñèãíàëà äëÿ èñêëþ÷åíèÿ ïåðåêðûòèÿ åãî ðåçóëüòàìè èçìåðåíèé",
        "Decrease or no zone output signal to avoid overlapping of its measurement results"
    },
    {
        {"Êàê åñòü",    "As is"},
        {"Óìåíüøàòü",   "Reduce"}
    },
    (int8 *)&set.meas_ModeViewSignals
};

static bool IsActive_Mode(void)
{
    return SHOW_MEASURES;
}


// ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
static const Page ppTune =
{
    Item_Page, &pMeasures, IsActive_Tune,
    {
        "ÍÀÑÒÐÎÈÒÜ", "CONFIGURE",
        "Ïåðåõîä â ðåæìè òî÷íîé íàñòðîéêè êîëè÷åñòâà è âèäîâ èçìåðåíèé",
        "Transition to rezhm of exact control of quantity and types of measurements"
    },
    PageSB_Measures_Tune,
    {
        (void *)&bTune_Exit,    // ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Âûõîä
        (void *)0,
        (void *)0,
        (void *)0,
        (void *)&bTune_Markers, // ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Ìàðêåðû
        (void *)&bTune_Settings // ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Íàñòðîéêà
    },
    true, 0, 0, OnRegSet_Tune
};

static bool IsActive_Tune(void)
{
    return SHOW_MEASURES;
}

static void OnRegSet_Tune(int angle)
{
    static const int8 step = 3;
    static int8 currentAngle = 0;
    currentAngle += (int8)angle;
    if (currentAngle < step && currentAngle > -step)
    {
        return;
    }
    if (pageChoiceIsActive)
    {
        posOnPageChoice += (int8)Math_Sign(currentAngle);
        Sound_RegulatorSwitchRotate();
        if (posOnPageChoice < 0)
        {
            posOnPageChoice = Measure_NumMeasures - 1;
        }
        else if (posOnPageChoice == Measure_NumMeasures)
        {
            posOnPageChoice = 0;
        }
        MEASURE(posActive) = (Measure)posOnPageChoice;
        Painter_ResetFlash();
    }
    else
    {
        int row = 0;
        int col = 0;
        Measure_GetActive(&row, &col);
        col += Math_Sign(currentAngle);
        if (col < 0)
        {
            col = Measure_NumCols() - 1;
            row--;
            if (row < 0)
            {
                row = Measure_NumRows() - 1;
            }
        }
        else if (col == Measure_NumCols())
        {
            col = 0;
            row++;
            if (row >= Measure_NumRows())
            {
                row = 0;
            }
        }
        Measure_SetActive(row, col);
        Sound_RegulatorSwitchRotate();
    }
    currentAngle = 0;
}

// ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Âûõîä ---------------------------------------------------------------------------------------------------------------------
static const SButton bTune_Exit =
{
    Item_SmallButton, &ppTune,
    COMMON_BEGIN_SB_EXIT,
    OnPressSB_Exit,
    DrawSB_Exit
};

// ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Ìàðêåðû -------------------------------------------------------------------------------------------------------------------
static const SButton bTune_Markers =
{
    Item_SmallButton, &ppTune, 0,
    {
        "Ìàðêåð", "Marker",
        "Ïîçâîëÿåò óñòàíîâèòü ìàðêåðû äëÿ âèçóàëüíîãî êîíòðîëÿ èçìåðåíèé",
        "Allows to establish markers for visual control of measurements"
    },
    OnPress_Tune_Markers,
    Draw_Tune_Markers
};

static void OnPress_Tune_Markers(void)
{
    Measure_ShortPressOnSmallButonMarker();
}

static void Draw_Tune_Markers(int x, int y)
{
    Painter_SetFont(TypeFont_UGO2);
    Painter_Draw4SymbolsInRect(x + 2, y + 2, '\x60');
    Painter_SetFont(TypeFont_8);
}

// ÈÇÌÅÐÅÍÈß - ÍÀÑÒÐÎÈÒÜ - Íàñòðîéêà -----------------------------------------------------------------------------------------------------------------
static const SButton bTune_Settings =
{
    Item_SmallButton, &ppTune, 0,
    {
        "Íàñòðîéêà", "Setup",
        "Ïîçâîëÿåò âûáðàòü íåîáõîäèìûå èçìåðåíèÿ",
        "Allows to choose necessary measurements"
    },
    OnPress_Tune_Settings,
    Draw_Tune_Settings
};

static void OnPress_Tune_Settings(void)
{
    pageChoiceIsActive = !pageChoiceIsActive;
    if (pageChoiceIsActive)
    {
        posOnPageChoice = MEASURE(posActive); //-V2006
    }
}

static void Draw_Tune_Settings(int x, int y)
{
    Painter_SetFont(TypeFont_UGO2);
    Painter_Draw4SymbolsInRect(x + 2, y + 1, '\x62');
    Painter_SetFont(TypeFont_8);
}
